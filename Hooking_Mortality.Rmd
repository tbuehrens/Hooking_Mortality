---
title: "Hooking Mortality"
author: "TBD"
output:
  html_document:
    fig_caption: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

***

Page Last Updated: `r format(Sys.time(), '%m/%d/%Y')`.

***


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Functions
```{r load functions, results = "hide",echo = T, message = FALSE, warning = FALSE}
wd_functions<-"functions"
sapply(FUN = source, paste(wd_functions, list.files(wd_functions), sep="/"))
```

# Install & Load Packages
This section of code will load the packages we need to complete the analysis
```{r load packages, results = "hide",echo = T, message = FALSE, warning = FALSE}
packages_list<-c("tidyverse", "plyr","dplyr", "lubridate","tidyr","scales","RODBC","MuMIn","RColorBrewer","reshape2","ggplot2","gplots","mgcv","sjPlot","sjmisc","gridExtra","modelr","kableExtra","dataRetrieval","MASS","brms","rstan") 
install_or_load_pack(pack = packages_list)
```


# Read and organize data
```{r load data, results = "hide",echo = T, message = FALSE, warning = FALSE }
# all captures
capture.df<-odbc(accdb.name="CowlitzHookingMortalityDB.accdb",db.dir=getwd(),dsn="MS Access Database", sqtable="All Captures Query", fields= "*")%>%
  as_tibble()%>%
  mutate(
    Year = as.numeric(year(ymd(as.character(Survey_Date)))),
    Month = as.numeric(month(ymd(as.character(Survey_Date)))),
    jdate = as.numeric(julian(ymd(as.character(Survey_Date)))),
    DOY = as.numeric(yday(ymd(as.character(Survey_Date)))),
    Capture_Type = ifelse(Capcode=="0", "No_Captures",
                                 ifelse(Capcode=="1", "New_Fish",
                                    ifelse(Capcode=="2", "Recapture",
                                      ifelse(Capcode=="3", "Natural_Origin",
                                        ifelse(Capcode=="5", "New_Fish","Lost"))))), #all variants of Capcode 4 were lost (we may want to differentiate for some analyses)
     #define initial capture as a control or treatment
    Treatment = ifelse(Survey_type%in%c("Control Release TP","Control Release MHE","Control Recycle"), "Control",
                                ifelse(Survey_type=="Angling", "Treatment","Other")),
    run_year = as.numeric(ifelse(as.numeric(Year=="2017")&as.numeric(Month>8)&SpeciesCode=="COHO","2017",
                               ifelse(as.numeric(Year=="2018")&as.numeric(Month<5)&SpeciesCode=="COHO","2017",
                                      ifelse(as.numeric(Year=="2018")&as.numeric(Month>8)&SpeciesCode=="COHO","2018",
                                             ifelse(as.numeric(Year=="2019")&as.numeric(Month<5)&SpeciesCode=="COHO","2018",
                                                    ifelse(as.numeric(Year=="2019")&as.numeric(Month>8)&SpeciesCode=="COHO","2019",
                                                           ifelse(as.numeric(Year=="2020")&as.numeric(Month<5)&SpeciesCode=="COHO","2019",
                                                                  ifelse(as.numeric(Year=="2017")&SpeciesCode=="STLHD","2017",
                                                                         ifelse(as.numeric(Year=="2018")&SpeciesCode=="STLHD","2018",
                                                                                ifelse(as.numeric(Year=="2019")&SpeciesCode=="STLHD","2019",
                                                                                       ifelse(as.numeric(Year=="2020")&as.numeric(Month<2)&SpeciesCode=="STLHD","2019",
                                                                                              ifelse(as.numeric(Year=="2020")&as.numeric(Month>2)&SpeciesCode=="STLHD","2020",as.numeric(Year))))))))))))
  ))
  
#only first captures that were new fish (T or C)
firstcapture = capture.df%>%
  filter(Capcode=="1"|Capcode =="5") #these are initial captures and excludes Capcode 3s and 4s

#only first recaptures
recapture = capture.df%>%
  filter(Capcode=="2")%>%
  group_by(Fish_ID)%>%
  arrange(Survey_Date,TimeCapture)%>%
  slice(1L) #get first data/time recapure for each fish ID
  
#merge capture-recapture
dat<-firstcapture%>%
  left_join(recapture, by="Fish_ID",suffix=c("_cap","_recap")) #join first captures with first recaptures

#control fish dataframe
cdat<-dat%>%
  filter(Treatment_cap=="Control")%>%
  mutate(rec=ifelse(!is.na(DOY_recap),1,0)
           )
```

# GAM analysis of factors affecting prob of recapture
```{r GAM analysis, results="hold",echo = T, message = T, warning = FALSE }
cdat<-cdat%>%
  filter(SpeciesCode_cap=="COHO")%>%
  dplyr::select(
    rec,
    Fish_ID,
    run_year_cap,
    DOY_cap,
    Temp_C_cap,
    Release_Location_cap,
    Capture_Location_recap
                )%>%
  mutate(run_year_cap = factor(run_year_cap))

m1<-gam(rec ~ 
          1
          + s(run_year_cap,bs="re") 
          + s(DOY_cap,bs="ps",k=30,m=1)
          + s(DOY_cap,run_year_cap,bs="fs",k=20,m=1)
          #+ s(Temp_C_cap,m=1)
          ,family = binomial(link="logit")
          ,data=cdat
    )

cat("\\begin{verbatim}")
cat(print("Summary GAM results for probability of recapture for control coho"))
try(cat(print(summary(m1)),silent = T))
cat(print("GAM Goodness of Fit check for probability of recapture for control coho"))
try(cat(print(gam.check(m1)),silent = T))
cat("\\end{verbatim}")


newdat<-expand.grid(
  DOY_cap = seq(from=min(cdat$DOY_cap),to=max(cdat$DOY_cap)),
  run_year_cap = unique(cdat$run_year_cap)
  )%>%
  as_tibble()%>%
  add_predictions(model=m1,var="preds",type = "response")

ggplot(newdat,aes(x=DOY_cap,y=preds,color=run_year_cap))+
  geom_line(size=0.8)+
  ylim(0,1)+
  ylab("Predicted Probability of Recapture")+
  theme_bw()
```


# Simulation GLM for dummy variable survival analysis
```{r simulated data model check, results="hold",echo = T, message = T, warning = FALSE }
n<-2000 #total fish
n_t=round(0.5*n) #number of treatment fish
TC<-data.frame(TC=c(rep(0,(n-n_t)),rep(1,n_t))) #dummy vector for Treatment and controls
k_rec<-3 #count of global covariates including global intercept
k_surv<-2 #count of global covariates
b<-rnorm(k_rec+k_surv,0,1) # beta's for global covariates
x<-bind_cols(data.frame("int"=rep(1,n)),as_tibble(mvrnorm(n=n,mu=rep(0,k_rec+k_surv-1), Sigma=diag(k_rec+k_surv-1)))) #design matrix


#=========
# binomial
#=========
logit_pred<-data.frame(logit_pred=as.matrix(x[,1:k_rec]) %*% b[1:k_rec] + #global covariates and intercept
    as.matrix((as.matrix(x[,(k_rec+1):(k_rec+k_surv)]) * cbind(TC,TC))) %*% b[(k_rec+1):(k_rec+k_surv)]) #treatment covariates (interaction with dummy variable)

#=========
# R2R
#=========
logit_pred<-data.frame(logit_pred=logit(ilogit(as.matrix(x[,1:k_rec]) %*% b[1:k_rec] + #global covariates and intercept
                                               as.matrix((as.matrix(x[,(k_rec+1):(k_rec+k_surv)]) * cbind(TC,TC))) %*% b[(k_rec+1):(k_rec+k_surv)]))) #treatment covariates (interaction with dummy variable)

dat<-x%>%
  bind_cols(TC)%>%
  bind_cols(logit_pred)%>%
  as_tibble()%>%
  mutate(
  rec = rbinom(n=n, size=1, prob= ilogit(logit_pred))
  )


#==========
# BRMS fits
#==========
fmla<-as.formula(paste0("rec ~ ",paste("V",1:(k_rec-1),sep="",collapse =   "+ "),"+", paste("TC : V",(k_rec):(k_rec+k_surv-1),sep="",collapse =   "+ ")))

#m1<-brm(fmla, family = bernoulli(link="logit"),data=dat,cores = 4,chains=4,iter=2000,warmup = 1000)
#m1<-brm(fmla, family = poisson(link="log"),data=dat,cores = 4,chains=4,iter=2000,warmup = 1000)
m1<-glm(fmla, family = binomial(link="logit"),data=dat)

cat("\\begin{verbatim}")
cat(print("Summary GLM results with simulated data"))
try(cat(print(summary(m1)),silent = T))
cat(print("Actual parameter values used to generate simulated data"))
print(b)
cat("\\end{verbatim}")
```

# A stan model for fitting R2R models with no covariates
```{stan output.var="model"}

data{
  int n;//number of observations (fish)
  int rec[n]; //bernoulli variable indicating if an individual recovered
  int TC[n]; //dummy variable indicating if an individual is a T or C
}
parameters{
  real<lower=0,upper=1> p[2];
}
transformed parameters{
  //logit(p[i]) =
}
model{
  //priors
  p ~ beta(1,1);
  //likelihoods
  for(i in 1:n){
    if(TC[i]==1){
      rec[i] ~ bernoulli(p[1]);
    }else{
      rec[i] ~ bernoulli(p[1]*p[2]);
    }
  }
}

```

# Notes on Analysis
1. Time to recovery (survival analysis)
2. Binomial-logit with dummy variable with dummy variable for TC
3. Split binomial R2R
4. Exploratory analysis
3. Cap-code 5 would indicate an "unaccounted for" control effect 


# Notes on DB:
1.	Capcodes really important
  a.	Filter out capcode 0’s
  b.	Filter out wild fish
  c.	Capcode 5 = fish that went from control release to treatment fish
    i.	Initially tags pulled and new floys put in fish
    ii.	Later, fish simply release with old floys
2.	Multiple recap fish
  a.	Make sure to filter for initial releases and only “count” single recapture
3.	Remove fish that aren’t available for recapture
  a.	Capcode 1---look for “loss on capture” (mortality) in both treatments and controls
  i.	(only 5 controls died)
4.	Look for errata
  a.	Example: fish that had no release record but were recovered, we created a release record

